<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <script src="./js/BridgeInitializer.js"></script>
    <title>Android WebView Sample</title>
</head>

<body style="margin: 0;">
    <header style="text-align: center; height: 100px; line-height: 100px;">
        <h1 style="margin: 0;">Android WebView</h1>
    </header>
    <hr style="margin: 0;">
    <div class="container" style="margin-top: 300px; padding: 0 10px; text-align: center; position: relative;">
        <i id="flash"
            style="position: absolute; top: -80px; width: 30px; height: 30px; left: calc(50% - 15px); display: none;">
            <svg viewBox="64 64 896 896" data-icon="funnel-plot" width="1em" height="1em" fill="currentColor"
                aria-hidden="true" focusable="false" class="" style="color: #fe8e14; font-size: 30px;">
                <path
                    d="M880.1 154H143.9c-24.5 0-39.8 26.7-27.5 48L349 607.4V838c0 17.7 14.2 32 31.8 32h262.4c17.6 0 31.8-14.3 31.8-32V607.4L907.7 202c12.2-21.3-3.1-48-27.6-48zM603.4 798H420.6V650h182.9v148zm9.6-226.6l-8.4 14.6H419.3l-8.4-14.6L334.4 438h355.2L613 571.4zM726.3 374H297.7l-85-148h598.6l-85 148z">
                </path>
            </svg>
        </i>
        <button id="start" style="margin: 5px 0;">Start Scan</button>
        <button id="stop" style="margin: 5px 0; display: none;">Stop Scan</button>
        <h4 id="results"></h4>
        <hr>
        <span>Choose the Formats to Detect: </span>
        <form id="chooseBarcodeFormats">
            <input type="checkbox" id="OneD" name="barcodeFormat" value="BF_ONED" checked>
            <label for="OneD"> 1D </label><br />
            <input type="checkbox" id="QR" name="barcodeFormat" value="BF_QR_CODE" checked>
            <label for="QR"> QR Code </label><br />
            <input type="checkbox" id="PDF417" name="barcodeFormat" value="BF_PDF417">
            <label for="PDF417"> PDF 417 </label><br />
            <input type="checkbox" id="Datamatrix" name="barcodeFormat" value="BF_DATAMATRIX">
            <label for="Datamatrix"> DataMatrix </label> <br />
        </form>
        <span>Expected barcode count per frame: </span>
        <input type="range" min="1" max="20" step="1" id="expectedNumberBarcodes" value="1">
        <span id="expectedNumberBarcodesLabel">1</span>
    </div>

    <script>
        (async () => {
            // set the position of the CameraView
            // [marginLeft, marginTop, width, height] / px
            dbrWebViewBridge.setCameraUI([window.screen.width / 2 - 125, 125, 250, 250]);
            await updateBarcodeFormats();

            dbrWebViewBridge.onBarcodeRead = results => {
                let resultText = "";
                JSON.parse(results).forEach(result => {
                    resultText += result.barcodeText + " ";
                });
                document.getElementById("results").innerText = resultText;
            };
        })();

        let flashFlag = false;
        const startBtn = document.getElementById("start");
        const stopBtn = document.getElementById("stop");
        const flashBtn = document.getElementById("flash");
        const formatsForm = document.getElementById("chooseBarcodeFormats");
        const expectedRange = document.getElementById("expectedNumberBarcodes");

        startBtn.addEventListener("click", () => {
            startBtn.style.display = "none";
            flashBtn.style.display = "inline-block";
            stopBtn.style.display = "inline-block";
            dbrWebViewBridge.startScanning();
        });
        stopBtn.addEventListener("click", () => {
            stopBtn.style.display = "none";
            flashBtn.style.display = "none";
            startBtn.style.display = "inline-block";
            dbrWebViewBridge.stopScanning();
        });
        flashBtn.addEventListener("click", () => {
            dbrWebViewBridge.switchFlashlight(!flashFlag);
            flashFlag = !flashFlag;
        });
        formatsForm.addEventListener("change", async () => {
            await updateBarcodeFormats();
        });
        expectedRange.addEventListener("change", async () => {
            let expectedVal = document.getElementById('expectedNumberBarcodes').value;
            document.getElementById('expectedNumberBarcodesLabel').innerText = expectedVal;
            const settings = await dbrWebViewBridge.getRuntimeSettings();
            settings.expectedBarcodesCount = parseInt(expectedVal);
            await dbrWebViewBridge.updateRuntimeSettings(settings);
        });

        async function updateBarcodeFormats() {
            const EnumBarcodeFormat = await dbrWebViewBridge.getEnumBarcodeFormat();
            const settings = await dbrWebViewBridge.getRuntimeSettings();
            settings.barcodeFormatIds = EnumBarcodeFormat.BF_NULL;
            const checkboxes = document.querySelectorAll('input[name="barcodeFormat"]:checked');
            checkboxes.forEach((checkbox) => {
                switch (checkbox.value) {
                    case "BF_ONED":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_ONED;
                        break;
                    case "BF_QR_CODE":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_QR_CODE;
                        break;
                    case "BF_PDF417":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_PDF417;
                        break;
                    case "BF_DATAMATRIX":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_DATAMATRIX;
                        break;
                }
            });
            await dbrWebViewBridge.updateRuntimeSettings(settings);
        }

    </script>
</body>

</html>