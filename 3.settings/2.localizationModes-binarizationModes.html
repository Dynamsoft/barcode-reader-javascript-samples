<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Dynamsoft Barcode Reader Sample - Using Runtime Settings</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@8.2.3/dist/dbr.js"></script>
    <link rel="stylesheet" href="settings-css.css">
    <link rel="stylesheet" href="../balloon.min.css"> <!-- Used for tooltip styling -->

</head>

<!-- This sample demonstrates the minimum necessary JavaScript code to get the BarcodeScanner (video) up and running. The BarcodeScanner object is initialized with its default UI once the user clicks the 'Read Barcode via Camera' button. Any unique barcode results that are found are then displayed in an alert box to the user. 
Please note that the organizationID '200001' corresponds to Dynamsoft's public license which is reserved for public samples. When hosting the sample in your own environment, please obtain a private trial by contacting the Dynamsoft Support Team via support@dynamsoft.com -->

<body>
    <button id='readBarcode'>Open Camera and Read Barcode</button>
    <p></p>
    <button id='openSimpleSettingsMenu'>Open Runtime Settings Menu</button>

    <!-- Manually defining the div that will contain the video so that the UI doesn't take up the full screen, hiding the  -->
    <div id="div-video-container">
        <video class="dbrScanner-video" playsinline="true"></video>
    </div>

    <!-- Settings Menu displayed in a modal -->
    <div id="settingsModal" class="modal">
        <div id="settingsContent" class="modal-content">
            <span id="closeModalBtn" class="closeModal">&times;</span>
            <div class="tooltip"
                aria-label="Selecting the approporiate localization mode priority order depending on the user scenario or the barcode format can help improve the SDK's speed and accuracy"
                data-balloon-pos="down" data-balloon-length="medium">Select the Localization Modes in Decreasing
                Priority Order (Highest to Lowest)</div>

            <form id="localizationMode">
                <input type="checkbox" id="connectedBlocks" name="locMode" value="LM_CONNECTED_BLOCKS">
                <label for="connectedBlocks"> Connected Blocks </label><br>
                <input type="checkbox" id="statistics" name="locMode" value="LM_STATISTICS">
                <label for="statistics"> Statistics </label><br>
                <input type="checkbox" id="lines" name="locMode" value="LM_LINES">
                <label for="lines"> Lines </label><br>
                <input type="checkbox" id="scanDirectly" name="locMode" value="LM_SCAN_DIRECTLY">
                <label for="scanDirectly"> Scan Directly </label> <br>
                <input type="checkbox" id="statMarks" name="locMode" value="LM_STATISTICS_MARKS">
                <label for="statMarks"> Statistics Marks </label> <br>
                <input type="checkbox" id="statPostal" name="locMode" value="LM_STATISTICS_POSTAL_CODE">
                <label for="statPostal"> Statistics Postal Code </label> <br>
                <input type="checkbox" id="skipLoc" name="locMode" value="LM_SKIP">
                <label for="skip"> Skip </label> <br>
            </form><br>

            <div class="tooltip"
                aria-label="Selecting the approporiate binarization mode can help increase the accuracy of barcode localization by providing the SDK with the best quality binary image."
                data-balloon-pos="down" data-balloon-length="medium">Select the Binarization Modes in Decreasing
                Priority Order (Highest to Lowest)
            </div>

            <form id="binarizationMode">
                <input type="checkbox" id="localBlock" name="binMode" value="BM_LOCAL_BLOCK">
                <label for="localBlock"> Local Block </label><br>

                <!-- Mode Arguments for the local block binarization mode-->
                <div class="localBlockForm">
                    <label for="blockSizeX" class="tooltip"
                        aria-label="Sets the horizontal block size [0-1000] for the binarization process. Please see documentation on what the values represent."
                        data-balloon-pos="down" data-balloon-length="medium">Horizontal Block Size
                    </label>
                    <input type="range" id="blockSizeX" name="blockSizeX" data-require-pair="#localBlock" min="0"
                        max="1000" value="0"><span id="blockSizeXDisplay"></span></br>

                    <label for="blockSizeY" class="tooltip"
                        aria-label="Sets the vertical block size [0-1000] for the binarization process. Please see documentation on what the values represent."
                        data-balloon-pos="down" data-balloon-length="medium">Vertical Block Size
                    </label>
                    <input type="range" id="blockSizeY" name="blockSizeY" data-require-pair="#localBlock" min="0"
                        max="1000" value="0"><span id="blockSizeYDisplay"></span></br>

                    <label for="enableFillBinary" class="tooltip"
                        aria-label="For barcodes of a large module size, it is recommended to set this property to true. Please see documentation for more info."
                        data-balloon-pos="down" data-balloon-length="medium">Enable Fill Binary Vacancy
                    </label>
                    <input type="checkbox" id="enableFillBinary" name="enableFillBinary"
                        data-require-pair="#localBlock"><br>

                    <label for="imagePreModes" class="tooltip"
                        aria-label="If the image preprocessing modes are being used, the following property specifies which index in the modes array the local block binarization will be applied to. By default, it is applied to all the modes."
                        data-balloon-pos="down" data-balloon-length="medium">Image Pre-processing Modes Index
                    </label>
                    <input type="range" id="imagePreModes" name="imagePreModes" data-require-pair="#localBlock" min="-1"
                        max="3" value="-1"><span id="imagePreModesDisplay"></span></br>

                </div>

                <!-- Mode Arguments for the threshold binarization mode-->
                <input type="checkbox" id="threshold" name="binMode" value="BM_THRESHOLD">
                <label for="threshold"> Threshold </label><br>

                <div class="thresholdForm">
                    <label for="binThreshold" class="tooltip"
                        aria-label="This threshold is used to classify the pixel values for the binarization process."
                        data-balloon-pos="down" data-balloon-length="medium">Binarization Threshold
                    </label>
                    <input type="range" id="binThreshold" name="binThreshold" data-require-pair="#localBlock" min="-1"
                        max="255" value="-1"><span id="binThresholdDisplay"></span></br>

                    <label for="imagePreModesThres" class="tooltip"
                        aria-label="If the image preprocessing modes are being used, the following property specifies which index in the modes array the threshold binarization will be applied to. By default, it is applied to all the modes."
                        data-balloon-pos="down" data-balloon-length="medium">Image Pre-processing Modes Index
                    </label>
                    <input type="range" id="imagePreModesThres" name="imagePreModesThres" data-require-pair="#threshold"
                        min="-1" max="3" value="-1"><span id="imagePreModesThresDisplay"></span></br>
                </div>

                <input type="checkbox" id="skipBin" name="binMode" value="BM_SKIP">
                <label for="threshold"> Skip</label></br>

            </form><br>

        </div>
    </div>

    <!-- JS Code -->
    <script src="initScanner.js"></script> <!-- To initialize the barcode scanner -->

    <script>

        /* When one or multiple of the localization mode options are selected, update the runtime settings. The localization modes
            need to be set in order of priority, thus the code takes into account the order in which the user selects the checkbox options
            Whenever a localization mode checkbox is clicked, push it to the localization mode array. With hos this is set up, the localization modes must be selected in decreasing priority (highest to lowest)*/
        const checkboxesLocalization = document.querySelectorAll('input[name="locMode"]');
        for (var i = 0; i < checkboxesLocalization.length; i++) {
            checkboxesLocalization[i].addEventListener('click', async function () {
                let settings = await scanner.getRuntimeSettings();
                if (this.checked) {
                    switch (this.value) {
                        case "LM_CONNECTED_BLOCKS":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_CONNECTED_BLOCKS;
                            break;
                        case "LM_STATISTICS":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_STATISTICS;
                            break;
                        case "LM_LINES":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_LINES;
                            break;
                        case "LM_SCAN_DIRECTLY":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_SCAN_DIRECTLY;
                            break;
                        case "LM_STATISTICS_MARKS":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_STATISTICS_MARKS;
                            break;
                        case "LM_STATISTICS_POSTAL_CODE":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_STATISTICS_POSTAL_CODE;
                            break;
                        case "LM_SKIP":
                            settings.localizationModes[locModeCount] = Dynamsoft.DBR.EnumLocalizationMode.LM_SKIP;
                            break;
                    }
                }
                // So that the localization modes array stays at a length of 8 no matter how many times options are clicked
                if (locModeCount == 7)
                    locModeCount = 0;
                else
                    locModeCount++;

                console.log(settings.localizationModes); // check that the localization modes array is correct
                await scanner.updateRuntimeSettings(settings);
            })
        }
        /* End of localization mode assignment */

        /* Beginning of binarization mode assignment */
        let localBlock = document.getElementById("localBlock");

        // Local Block Binarization Mode Arguments
        let blockSizeX = document.getElementById("blockSizeX");
        let blockSizeY = document.getElementById("blockSizeY");
        let enableBinary = document.getElementById("enableFillBinary");
        let imagePreModesLB = document.getElementById("imagePreModes");

        // Threshold Binarization Mode Arguments
        let binThreshold = document.getElementById("binThreshold");
        let imagePreModesT = document.getElementById("imagePreModesThres");

        // Loop through the localization mode options and assign them to the localization modes array in the order they are selected.
        const checkboxesBinarization = document.querySelectorAll('input[name="binMode"]');
        for (var i = 0; i < checkboxesBinarization.length; i++) {
            checkboxesBinarization[i].addEventListener('click', async function () {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (this.checked) {
                        switch (this.value) {
                            case "BM_LOCAL_BLOCK":
                                settings.binarizationModes[binModeCount] = Dynamsoft.DBR.EnumBinarizationMode.BM_LOCAL_BLOCK;
                                break;
                            case "BM_THRESHOLD":
                                settings.binarizationModes[binModeCount] = Dynamsoft.DBR.EnumBinarizationMode.BM_THRESHOLD;
                                break;
                            case "BM_SKIP":
                                settings.binarizationModes[binModeCount] = Dynamsoft.DBR.EnumBinarizationMode.BM_SKIP;
                                break;
                        }
                    }
                    // So that the binarization modes array stays at a max length of 8 no matter how many times options are clicked
                    if (binModeCount == 7)
                        binModeCount = 0;
                    else
                        binModeCount++;

                    console.log(settings.binarizationModes);
                    await scanner.updateRuntimeSettings(settings);
                }
                catch (ex) {
                    console.log(ex.message);
                }
            })
        }

        /* If local block binarization is selected, open up the local block binarization options
        Once one of the options is changed, for example block size X, apply this change to the SDK's settings*/
        localBlock.onclick = function () {
            let localBlockForm = document.getElementsByClassName("localBlockForm");
            localBlockForm[0].style.display = "block";
        }

        /* Applying the local block binarization options to the settings, starting with the horizontal block size */
        blockSizeX.onchange = async function () {
            document.getElementById("blockSizeXDisplay").innerHTML = blockSizeX.value.toString(); // display the slider value next to it
            // Get the index of the local block binarization mode in the binarization modes array. max length of array is 8 as explained above.
            for (var i = 0; i <= 8; i++) {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (settings.binarizationModes[i] == Dynamsoft.DBR.EnumBinarizationMode.BM_LOCAL_BLOCK)
                        //once the index is found, use the index to set the mode argument.
                        await scanner.setModeArgument("BinarizationModes", i, "BlockSizeX", blockSizeX.value.toString()); // set the horizontal block size
                    else
                        continue; // if not local block, skip to next iteration
                }
                catch (ex) {
                    console.log(ex.message);
                }
            }
        }

        // Set the mode argument vertical block size of the local block binarization mode
        blockSizeY.onchange = async function () {
            document.getElementById("blockSizeYDisplay").innerHTML = blockSizeY.value.toString(); // display the slider value next to it
            // Get the index of the local block binarization mode in the binarization modes array. max length of array is 8.
            for (var i = 0; i <= 8; i++) {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (settings.binarizationModes[i] == Dynamsoft.DBR.EnumBinarizationMode.BM_LOCAL_BLOCK)
                        await scanner.setModeArgument("BinarizationModes", i, "BlockSizeY", blockSizeY.value.toString()); // set the vertical block size
                    else
                        continue;
                } catch (ex) {
                    console.log(ex.message);
                }
            }
        }

        // Set the mode argument enable binary fill vacancy 
        enableBinary.onchange = async function () {
            // Get the index of the local block binarization mode in the binarization modes array. max length of array is 8.
            for (var i = 0; i <= 8; i++) {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (settings.binarizationModes[i] == Dynamsoft.DBR.EnumBinarizationMode.BM_LOCAL_BLOCK) {
                        let boolVal = (enableBinary.checked | 0).toString();
                        await scanner.setModeArgument("BinarizationModes", i, "EnableFillBinaryVacancy", boolVal); // set the horizontal block size
                    } else
                        continue;
                } catch (ex) {
                    console.log(ex.message);
                }
            }
        }

        // Setting the ImagePreprocessingModesIndex mode argument 
        imagePreModesLB.onchange = async function () {
            document.getElementById("imagePreModesDisplay").innerHTML = imagePreModesLB.value.toString(); // display the slider value next to it
            // Get the index of the local block binarization mode in the binarization modes array. max length of array is 8.
            for (var i = 0; i <= 8; i++) {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (settings.binarizationModes[i] == Dynamsoft.DBR.EnumBinarizationMode.BM_LOCAL_BLOCK)
                        await scanner.setModeArgument("BinarizationModes", i, "ImagePreprocessingModesIndex", imagePreModesLB.value.toString());
                    else
                        continue;
                } catch (ex) {
                    console.log(ex.message);
                }
            }
        }
        /* Done applying the local block binarization mode arguments */

        // Expand the threshold mode arguments options menu when threshold is checked
        let thresholdOption = document.getElementById("threshold");
        thresholdOption.onclick = function () {
            let thresholdForm = document.getElementsByClassName("thresholdForm");
            thresholdForm[0].style.display = "block";
        }

        /* Applying the threshold binarization mode arguments */

        // Applying the binarization threshold mode argument
        binThreshold.onchange = async function () {
            document.getElementById("binThresholdDisplay").innerHTML = binThreshold.value.toString(); // display the slider value next to it
            // Get the index of the threshold binarization mode in the binarization modes array. max length of array is 8.
            for (var i = 0; i <= 8; i++) {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (settings.binarizationModes[i] == Dynamsoft.DBR.EnumBinarizationMode.BM_THRESHOLD)
                        await scanner.setModeArgument("BinarizationModes", i, "BinarizationThreshold", binThreshold.value.toString());
                    else
                        continue;
                } catch (ex) {
                    console.log(ex.message);
                }
            }
        }

        // Setting the ImagePreprocessingModesIndex mode argument for threshold
        imagePreModesT.onchange = async function () {
            document.getElementById("imagePreModesThresDisplay").innerHTML = imagePreModesT.value.toString(); // display the slider value next to it
            // Get the index of the local block binarization mode in the binarization modes array. max length of array is 8.
            for (var i = 0; i <= 8; i++) {
                try {
                    let settings = await scanner.getRuntimeSettings();
                    if (settings.binarizationModes[i] == Dynamsoft.DBR.EnumBinarizationMode.BM_THRESHOLD)
                        await scanner.setModeArgument("BinarizationModes", i, "ImagePreprocessingModesIndex", imagePreModesT.value.toString());
                    else
                        continue;
                } catch (ex) {
                    console.log(ex.message);
                }
            }
        }
    /* Done applying the threshold binarization mode arguments */

    </script>
</body>

</html>