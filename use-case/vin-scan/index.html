<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta name="description" content="Quickly read barcodes with Dynamsoft Barcode Reader from a live camera stream." />
    <meta name="keywords" content="barcode, camera" />
    <link rel="canonical" href="https://demo.dynamsoft.com/Samples/DBR/JS/hello-world/hello-world.html" />
    <title>Dynamsoft Barcode Reader Sample - Hello World (Decode via Camera)</title>
  </head>

  <body>
    <h1>Hello World (Decode via Camera) - Scan VIN</h1>
    <div id="camera-view-container" style="width: 100%; height: 80vh"></div>
    Results:<br />
    <div id="results" style="width: 100%; height: 10vh; overflow: auto"></div>
    <!-- <script src="https://cdn.jsdelivr.net/npm/dynamsoft-core@3.2.30/dist/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-license@3.2.21/dist/license.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-utility@1.2.20/dist/utility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-capture-vision-router@2.2.30/dist/cvr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@4.0.3/dist/dce.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader@10.2.10/dist/dbr.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@10.2.1000/dist/dbr.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-label-recognizer@3.2.30/dist/dlr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-code-parser@2.2.10/dist/dcp.js"></script>

    <!-- <script src="https://cdn.jsdelivr.net/npm/https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader@10.2.10/dist/-bundle@3.2.3000/dist/dlr.bundle.js"></script> -->
    <script>
      // Dynamsoft.Core.CoreModule.engineResourcePaths = {
      //   std: "https://cdn.jsdelivr.net/npm/dynamsoft-capture-vision-std@1.2.10/dist/",
      //   dip: "https://cdn.jsdelivr.net/npm/dynamsoft-image-processing@2.2.30/dist/",
      //   core: "https://cdn.jsdelivr.net/npm/dynamsoft-core@3.2.30/dist/",
      //   license: "https://cdn.jsdelivr.net/npm/dynamsoft-license@3.2.21/dist/",
      //   cvr: "https://cdn.jsdelivr.net/npm/dynamsoft-capture-vision-router@2.2.30/dist/",
      //   dbr: "https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader@10.2.10/dist/",
      //   dlr: "https://cdn.jsdelivr.net/npm/dynamsoft-label-recognizer@3.2.30/dist/",
      //   dce: "https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@4.0.3/dist/",
      // };

      /** LICENSE ALERT - README
       * To use the library, you need to first specify a license key using the API "initLicense()" as shown below.
       */

      Dynamsoft.License.LicenseManager.initLicense(
        "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTAyODk0NDUwLXIxNzE5NTI4MzY5IiwibWFpblNlcnZlclVSTCI6Imh0dHBzOi8vbWx0cy5keW5hbXNvZnQuY29tLyIsIm9yZ2FuaXphdGlvbklEIjoiMTAyODk0NDUwIiwic3RhbmRieVNlcnZlclVSTCI6Imh0dHBzOi8vc2x0cy5keW5hbXNvZnQuY29tLyIsImNoZWNrQ29kZSI6NjMzMjY3NjU1fQ=="
      );

      /**
       * You can visit https://www.dynamsoft.com/customer/license/trialLicense?utm_source=github&product=dbr&package=js to get your own trial license good for 30 days.
       * Note that if you downloaded this sample from Dynamsoft while logged in, the above license key may already be your own 30-day trial license.
       * For more information, see https://www.dynamsoft.com/barcode-reader/programming/javascript/user-guide/?ver=10.2.10&utm_source=github#specify-the-license or contact support@dynamsoft.com.
       * LICENSE ALERT - THE END
       */

      // Optional. Used to load wasm resources in advance, reducing latency between video playing and barcode decoding.
      Dynamsoft.Core.CoreModule.loadWasm(["DBR", "DLR", "DCP"]);
      Dynamsoft.DCP.CodeParserModule.loadSpec("VIN");

      // Defined globally for easy debugging.
      let cameraEnhancer, cvRoutemr, codeParser;

      (async () => {
        // try {
        // Create a CodeParser instance
        codeParser = await Dynamsoft.DCP.CodeParser.createInstance();

        // Create a `CameraEnhancer` instance for camera control and a `CameraView` instance for UI control.
        const cameraView = await Dynamsoft.DCE.CameraView.createInstance();
        cameraEnhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance(cameraView);
        // Get default UI and append it to DOM.
        document.querySelector("#camera-view-container").append(cameraView.getUIElement());

        // Create a `CaptureVisionRouter` instance and set `CameraEnhancer` instance as its image source.
        cvRouter = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
        cvRouter.setInput(cameraEnhancer);

        // Define a callback for results.
        cvRouter.addResultReceiver({
          onCapturedResultReceived: (result) => {
            if (!result.items.length) return;
            // console.log("@", result);
            const resultsContainer = document.querySelector("#results");
            resultsContainer.textContent = "";

            console.log(result);

            for (let item of result.items) {
              if (
                item.type != Dynamsoft.Core.EnumCapturedResultItemType.CRIT_BARCODE &&
                item.type != Dynamsoft.Core.EnumCapturedResultItemType.CRIT_TEXT_LINE
              ) {
                continue;
              }
              console.log("item", item);
              let _type;
              let parsedResultItem;

              if (item.type == Dynamsoft.Core.EnumCapturedResultItemType.CRIT_BARCODE) {
                _type = "barcode";
              } else if (item.type == Dynamsoft.Core.EnumCapturedResultItemType.CRIT_TEXT_LINE) {
                _type = "text";
              }

              callbackMrzOrVinRecognition(item.text);

              resultsContainer.textContent += `${_type}: ${
                _type == Dynamsoft.Core.EnumCapturedResultItemType.CRIT_BARCODE ? _type.formatType : ""
              } ${item.text}\n\n`;
            }
          },
        });

        // Filter out unchecked and duplicate results.
        const filter = new Dynamsoft.Utility.MultiFrameResultCrossFilter();
        // Filter out unchecked barcodes.
        filter.enableResultCrossVerification("barcode", true);
        // Filter out duplicate barcodes within 3 seconds.
        filter.enableResultDeduplication("barcode", true);
        // Filter out unchecked text lines
        filter.enableResultCrossVerification("text_line", true);
        // Filter out duplicate text lines within 3 seconds
        filter.enableResultDeduplication("text_line", true);
        await cvRouter.addResultFilter(filter);

        // Set parameters to read VIN through DLR and DBR
        const settings = {
          CaptureVisionTemplates: [
            {
              Name: "ReadVIN",
              ImageROIProcessingNameArray: ["roi-read-vin"],
            },
          ],
          TargetROIDefOptions: [
            {
              Name: "roi-read-vin",
              TaskSettingNameArray: ["task-read-vin-barcode", "task-read-vin-label", "task-parse-vin"],
            },
          ],

          // // Code parser task
          CodeParserTaskSettingOptions: [
            {
              Name: "task-parse-vin",
              CodeSpecifications: ["VIN"],
              ResourcesPath: "./resources/",
            },
          ],

          // Barcode Reading Task for VIN
          // Referenced from VIN Barcode Sample
          BarcodeReaderTaskSettingOptions: [
            {
              Name: "task-read-vin-barcode",
              ExpectedBarcodesCount: 1,
              BarcodeFormatSpecificationNameArray: ["bfs-vin-barcode"],
              LocalizationModes: [
                { Mode: "LM_STATISTICS_MARKS" },
                { Mode: "LM_LINES" },
                { Mode: "LM_CONNECTED_BLOCKS" },
              ],
              BarcodeColourModes: [
                {
                  Mode: "BICM_DARK_ON_LIGHT",
                },
                {
                  Mode: "BICM_DARK_ON_LIGHT_DARK_SURROUNDING",
                },
                {
                  Mode: "BICM_DARK_LIGHT_MIXED",
                },
              ],
            },
          ],
          BarcodeFormatSpecificationOptions: [
            {
              Name: "bfs-vin-barcode",
              BarcodeFormatIds: [
                "BF_CODE_39",
                "BF_CODE_128",
                "BF_CODE_93",
                "BF_CODE_39_EXTENDED",
                "BF_CODABAR",
                "BF_ITF",
                "BF_INDUSTRIAL_25",
                "BF_QR_CODE",
                "BF_DATAMATRIX",
              ],
              MirrorMode: "MM_BOTH",
            },
          ],
          // Label Recognizer Task for VIN
          LabelRecognizerTaskSettingOptions: [
            {
              Name: "task-read-vin-label",
              StringRegExPattern: "([0-9A-Z]{17,19})",
              StringLengthRange: [17, 19],
              SectionImageParameterArray: [
                {
                  Section: "ST_REGION_PREDETECTION",
                  ImageParameterName: "ip-recognize-vin-label",
                },
                {
                  Section: "ST_TEXT_LINE_LOCALIZATION",
                  ImageParameterName: "ip-recognize-vin-label",
                },
                {
                  Section: "ST_TEXT_LINE_RECOGNITION",
                  ImageParameterName: "ip-recognize-vin-label",
                },
              ],
            },
          ],
          ImageParameterOptions: [
            // Set the height of recognized textline to be 20px-1000px
            {
              Name: "ip-recognize-vin-label",
              TextDetectionMode: {
                Mode: "TTDM_LINE",
                Direction: "HORIZONTAL",
                CharHeightRange: [5, 1000, 1],
              },
              BinarizationModes: [
                {
                  Mode: "BM_LOCAL_BLOCK",
                  EnableFillBinaryVacancy: 0,
                },
              ],
              GrayscaleTransformationModes: [
                {
                  Mode: "GTM_AUTO",
                },
              ],
            },
          ],

          // Output
          // OutputTaskSettingOptions: [
          //   {
          //     Name: "output_vin",
          //     OutputCondition: {
          //       TaskResultArray: [
          //         {
          //           TargetROIDefName: "roi-read-vin-by-label",
          //           BackwardReferenceOutput: {
          //             ReferenceTaskNameArray: ["task-parse-vin"],
          //           },
          //         },
          //         {
          //           TargetROIDefName: "roi-read-vin-by-barcode",
          //           BackwardReferenceOutput: {
          //             ReferenceTaskNameArray: ["task-parse-vin"],
          //           },
          //         },
          //       ],
          //       Operator: "OR",
          //     },
          //   },
          // ],
        };
        await cvRouter.initSettings(settings);
        console.log("s", await cvRouter.outputSettings());

        // Open camera and start scanning single barcode.
        await cameraEnhancer.open();
        await cvRouter.startCapturing();
        // } catch (ex) {
        //   let errMsg = ex.message || ex;
        //   console.error(errMsg);
        //   alert(errMsg);
        // }
      })();

      function handleVinParseResult(result) {
        const parseResultInfo = {};
        if (!result.exception) {
          let region = result.getFieldValue("region");
          parseResultInfo["Region :"] = region;
          let checkDigit = result.getFieldValue("checkDigit");
          parseResultInfo["Check Digit :"] = checkDigit;
          let modelYear = result.getFieldValue("modelYear");
          parseResultInfo["Model Year :"] = modelYear;
          let plantCode = result.getFieldValue("plantCode");
          parseResultInfo["Plant Code :"] = plantCode;
          let vis = result.getFieldValue("VIS");
          parseResultInfo["VIS :"] = vis;
        }
        return parseResultInfo;
      }

      async function callbackMrzOrVinRecognition(text) {
        let resultArr = [];
        resultArr.push(text);

        let parseResultInfo = await codeParser.parse(resultArr.join(""));
        parseResultInfo = handleVinParseResult(parseResultInfo);
        if (JSON.stringify(parseResultInfo) === "{}") {
          console.error("Parse Failed!");
        }
        console.log("parsed", parseResultInfo);
      }
    </script>
  </body>
</html>
