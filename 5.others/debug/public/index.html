<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
</head>

<body>
    <button id="btn-show-scanner">show scanner</button>
    <br>
    <div id="div-video-container" style="width:100%;height:calc(100vh - 100px);"></div>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@8.6.1/dist/dbr.js"></script>
    <script>
        /** LICENSE ALERT - README
         * The library requires a license to work. If no license is specified, a 7-day built-in 
         * trial license will be used by default which is the case in this sample.
         * Note that network connection is required for this built-in license to work.
         */

        /* When using your own license, uncomment the following line and specify your own license string. */

        // Dynamsoft.DBR.initLicense("DLS2eyJvcmdhbml6YXR****");

        /** If you don't have a license yet, you can request a trial on this page: 
         * https://www.dynamsoft.com/customer/license/trialLicense?product=dbr&package=js&utm_source=sample
         * or, you can purchase a license on this page:
         * https://www.dynamsoft.com/store/dynamsoft-barcode-reader/#js?product=dbr&package=js&utm_source=sample
         */

        /** LICENSE ALERT - THE END */

        let pScanner = null;
        // decode video from camera
        document.getElementById('btn-show-scanner').addEventListener('click', async () => {
            try {
                let scanner = await (pScanner = pScanner || Dynamsoft.DBR.BarcodeScanner.createInstance());
                scanner.bPlaySoundOnSuccessfulRead = true;
                let rs = await scanner.getRuntimeSettings();
                rs.timeout = 100000;
                await scanner.updateRuntimeSettings(rs);
                let ss = await scanner.getScanSettings();
                ss.intervalTime = 100;
                await scanner.updateScanSettings(ss);
                scanner.ifSaveOriginalImageInACanvas = true;
                let processingCount = 0;
                scanner.onFrameRead = async results => {
                    /**
                     * The barcode reading speed is very fast, we must limit 
                     * the number of uploaded frames (4), so that it is feasible.
                     */ 
                    if (processingCount < 4) { 
                        ++processingCount;
                        try {
                            /**
                             * The original image is the one the reader worked on,
                             * we can collect it for futher testing and debugging.
                             */ 
                            let cvs = await scanner.getOriginalImageInACanvas();
                            let fd = new FormData();
                            if (cvs != null) {
                                let blob = cvs.convertToBlob ?
                                    await cvs.convertToBlob() :
                                    await new Promise(resolve => {
                                        cvs.toBlob(blob => resolve(blob));
                                    });
                                fd.append("img", blob);
                                await fetch("collect", {
                                    method: "POST",
                                    body: fd
                                });
                            }
                        } catch (ex) {
                            console.error(ex);
                        }
                        --processingCount;
                    }
                };
                document.getElementById('div-video-container').appendChild(scanner.getUIElement());
                await scanner.show();
            } catch (ex) {
                alert(ex.message);
                throw ex;
            }
        });
    </script>
</body>

</html>